- hosts: local

  tasks:

  - name: Check that ~/.pyenv already exists (delete it to reinstall)
    stat:
      path: ~/.pyenv
    register: pyenv_dir

  - name: Proceed
    when: not pyenv_dir.stat.exists
    block:
    - name: Install required packages
      become: true
      vars:
        apt_config: /etc/apt/apt.conf.d/99pyenvtmp
      block:
        # Sometimes apt can't update due to repo security reasons.
        - name: APT downgrade permissions
          when: ansible_pkg_mgr == 'apt'
          copy:
            content: |
              Acquire::AllowReleaseInfoChange "true";
              Acquire::AllowInsecureRepositories "true";
              Acquire::AllowDowngradeToInsecureRepositories "true";
            dest: "{{ apt_config }}"

        - name: Install packages for building the Python
          package:
            state: present
            name:
              - make
              - build-essential
              - libssl-dev
              - zlib1g-dev
              - libbz2-dev
              - libreadline-dev
              - libsqlite3-dev
              - wget
              - curl
              - llvm
              - libncursesw5-dev
              - xz-utils
              - tk-dev
              - libxml2-dev
              - libxmlsec1-dev
              - libffi-dev
              - liblzma-dev

        - name: APT restore permissions
          file:
            path: "{{ apt_config }}"
            state: absent

    - name: Install pyenv
      vars:
        pyenv_installer: ~/pyenv-install.sh
      block:
        # Avoiding of curl here just avoids the Ansible warnings,
        # but curl is still used by pyenv installer under the hood.
        - name: Download pyenv installer
          get_url:
            url: https://pyenv.run
            dest: "{{ pyenv_installer }}"
            mode: 0755
            force: yes

        - name: Install pyenv
          shell: "{{ pyenv_installer }}"

        - name: Delete pyenv installer
          file:
            path: "{{ pyenv_installer }}"
            state: absent
