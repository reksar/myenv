- hosts: local

  vars:
    myconf: "{{ playbook_dir | dirname | dirname }}"

  tasks:

  - name: Settings common
    include_vars:
      file: "{{ myconf }}/ansible/settings.yml"
      name: settings

  - name: Settings nvim
    set_fact:
      nvim:
        path: "{{ settings.user.run }}/nvim"
        src: "{{ settings.user.src }}/neovim"
        repo: "https://github.com/neovim/neovim.git"

  # TODO: check which nvim instead
  - name: Check nvim path exists
    stat:
      path: "{{ nvim.path }}"
    register: nvim_path

  - name: nvim path exists
    when: nvim_path.stat.exists
    debug:
      msg: |
        "Stopped. To proceed, delete the '{{ nvim.path }}'."
        "Optionally you can delete or update the '{{ nvim.src }}' repo."

  - name: Build and install the nvim
    when: not nvim_path.stat.exists
    block:

    - name: Get neovim sources
      git:
        repo: "{{ nvim.repo }}"
        dest: "{{ nvim.src }}"
        version: stable
        # Clone if not exists, but do not update automatically
        update: no

    # See https://github.com/neovim/neovim/wiki/Building-Neovim#build-prerequisites
    - name: Install packages for building nvim
      include_tasks: packages.yml
      vars:
        packages:
          - ninja-build
          - gettext
          - libtool
          - libtool-bin
          - autoconf
          - automake
          - cmake
          - g++
          - pkg-config
          - unzip
          - curl
          - doxygen

    - name: Build nvim
      make:
        chdir: "{{ nvim.src }}"
        params:
          CMAKE_BUILD_TYPE: "Release"
          CMAKE_INSTALL_PREFIX: "{{ nvim.path }}"
          USE_BUNDLED: "ON"
